package com.tuempresa.herramientaevaluacion.service;

import com.tuempresa.herramientaevaluacion.dto.EmpresaRequestDTO;
import com.tuempresa.herramientaevaluacion.entity.Empresa;
import com.tuempresa.herramientaevaluacion.entity.Respuesta;
import com.tuempresa.herramientaevaluacion.entity.Resultado;
import com.tuempresa.herramientaevaluacion.repository.EmpresaRepository;
import com.tuempresa.herramientaevaluacion.repository.RespuestaRepository;
import com.tuempresa.herramientaevaluacion.repository.ResultadoRepository;
import jakarta.transaction.Transactional;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.time.LocalDate;

@Service
public class EmpresaService {

    @Autowired
    private EmpresaRepository empresaRepository;

    @Autowired
    private RespuestaRepository respuestaRepository;

    @Autowired
    private ResultadoRepository resultadoRepository;

    @Transactional
    public void registrarEmpresa(EmpresaRequestDTO dto) {
        // 1. Crear Empresa
        Empresa empresa = new Empresa();
        empresa.setNombreEmpresa(dto.getNombreEmpresa());
        empresa.setResponsable(dto.getResponsable());
        empresa.setCargo(dto.getCargo());
        empresa.setCorreo(dto.getCorreo());
        empresa.setFechaRegistro(LocalDate.now());

        empresaRepository.save(empresa);

        // 2. Guardar respuestas
        int suma = 0;
        for (int i = 0; i < dto.getRespuestas().size(); i++) {
            Integer valor = dto.getRespuestas().get(i);
            suma += valor;

            Respuesta r = new Respuesta();
            r.setEmpresa(empresa);
            r.setNumeroPregunta(i + 1);
            r.setValor(valor);
            respuestaRepository.save(r);
        }

        // 3. Calcular nivel
        int promedio = Math.round(suma / 12.0f);
        String mensaje = obtenerMensajeNivel(promedio);

        // 4. Guardar resultado
        Resultado resultado = new Resultado();
        resultado.setEmpresa(empresa);
        resultado.setNivelMadurez(promedio);
        resultado.setMensaje(mensaje);
        resultadoRepository.save(resultado);
    }

    private String obtenerMensajeNivel(int nivel) {
        return switch (nivel) {
            case 1 -> "Tu empresa está empezando. ¡Ánimo!";
            case 2 -> "Vas en camino, puedes seguir mejorando.";
            case 3 -> "Buen trabajo. Hay aspectos por fortalecer.";
            case 4 -> "Excelente avance. Solo falta poco.";
            case 5 -> "¡Felicidades! Son expertos en tecnología.";
            default -> "Sin evaluación disponible.";
        };
    }
}
