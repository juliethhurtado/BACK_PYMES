package co.edu.unicauca.sgph.horario.infrastructure.output.persistence.repository;

import java.time.LocalTime;
import java.util.List;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

import co.edu.unicauca.sgph.common.enums.DiaSemanaEnum;
import co.edu.unicauca.sgph.curso.infrastructure.output.persistence.entity.CursoEntity;
import co.edu.unicauca.sgph.horario.infrastructure.input.DTOResponse.FranjaLibreOutDTO;
import co.edu.unicauca.sgph.horario.infrastructure.output.persistence.entity.HorarioEntity;

public interface HorarioRepositoryInt extends JpaRepository<HorarioEntity, Long> {
					    	
	public List<HorarioEntity> findByCurso(CursoEntity curso);
	
	@Query("SELECT new co.edu.unicauca.sgph.horario.infrastructure.input.DTOResponse.FranjaLibreOutDTO(" +
		       "    ef.idEspacioFisico, " +
		       "    d.dia, " +
		       "    ADDTIME('07:00:00', SEC_TO_TIME(franja.num * 7200)), " +
		       "    ADDTIME('07:00:00', SEC_TO_TIME((franja.num + 1) * 7200)), " +
		       "    ef.salon, " +
		       "    ef.capacidad, " +
		       "    te.tipo, " +
		       "    u.nombre " +
		       ") " +
		       "FROM EspacioFisicoEntity ef " +
		       "LEFT JOIN TipoEspacioFisicoEntity te ON ef.tipoEspacioFisico.tipo = te.tipo " +
		       "LEFT JOIN UbicacionEntity u ON ef.ubicacion.nombre = u.nombre, " +
		       "(SELECT 0 AS num UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION " +
		       " SELECT 5 UNION SELECT 6 UNION SELECT 7) AS franja, " +
		       "(SELECT 'LUNES' AS dia UNION SELECT 'MARTES' UNION SELECT 'MIERCOLES' " +
		       " UNION SELECT 'JUEVES' UNION SELECT 'VIERNES' UNION SELECT 'SABADO') AS d " +
		       "WHERE (:idEspacioFisico IS NULL OR ef.idEspacioFisico = :idEspacioFisico) " +
		       "AND (:salon IS NULL OR LOWER(ef.salon) LIKE LOWER(CONCAT('%', :salon, '%'))) " +
		       "AND (:ubicacion IS NULL OR ef.ubicacion.idUbicacion IN :ubicacion) " +
		       "AND (:horaInicio IS NULL OR ADDTIME('07:00:00', SEC_TO_TIME(franja.num * 7200)) >= :horaInicio) " +
		       "AND (:horaFin IS NULL OR ADDTIME('07:00:00', SEC_TO_TIME((franja.num + 1) * 7200)) <= :horaFin) " +
		       "AND NOT (ADDTIME('07:00:00', SEC_TO_TIME(franja.num * 7200)) = '13:00:00') " + // Excluir franja de 13:00 a 14:00
		       "AND NOT EXISTS (" +
		       "    SELECT 1 " +
		       "    FROM HorarioEspacioEntity he " +
		       "    JOIN HorarioEntity h ON he.idHorarioEspacio.idHorario = h.idHorario " +
		       "    WHERE he.idHorarioEspacio.idEspacioFisico = ef.idEspacioFisico " +
		       "    AND h.dia = d.dia " + // Se verifica cada día de lunes a sábado
		       "    AND ADDTIME('07:00:00', SEC_TO_TIME(franja.num * 7200)) < h.horaFin " +
		       "    AND ADDTIME('07:00:00', SEC_TO_TIME((franja.num + 1) * 7200)) > h.horaInicio" +
		       ")")
		Page<FranjaLibreOutDTO> filtrarFranjasLibres(
		    @Param("idEspacioFisico") Long idEspacioFisico,
		    @Param("horaInicio") LocalTime horaInicio,
		    @Param("horaFin") LocalTime horaFin,
		    @Param("salon") String salon,
		    @Param("ubicacion") List<Long> ubicacion,
		    Pageable pageable
		);


}
